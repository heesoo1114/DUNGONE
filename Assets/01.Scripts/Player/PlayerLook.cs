using UnityEngine;

public class PlayerLook : MonoBehaviour
{
    private PlayerController _playerController;
    private PlayerAnimator _anim;

    // cam
    private Camera _mainCam;
    private CameraController _camController;

    // rotate
    private Vector2 mousePos;
    private Vector3 rotDir;
    private Quaternion targetDir;

    [Header("RotateValue")]
    [SerializeField] private float rotXSpeed; // x축 회전 속도
    [SerializeField] private float rotYSpeed; // y축 회전 속도
    [SerializeField] private float limitMinX = -50; // 아래 50도까지
    [SerializeField] private float limitMaxX = 80;  // 위 80도까지

    [Header("Component")]
    [SerializeField] private Transform camPos; // pelvis -> spine 1, 2, 3 -> neck -> head

    private bool CanZoomIn => 
        (false == _playerController.IsShooting) && 
        (false == _playerController.IsMoving) && 
        (false == _playerController.IsReloading);

    private void Awake()
    {
        _mainCam = Camera.main;
        _camController = _mainCam.gameObject.GetComponent<CameraController>();
        _anim = GetComponent<PlayerAnimator>();
        _playerController = GetComponent<PlayerController>();
    }

    private void Update()
    {
        // rotation에서 x축이 상하회전, y축이 좌우회전임
        // 상하 회전 각도 제한 -> 플레이어 바디 상하좌우 회전
        // 카메라 반동 기준

        rotDir.x = Mathf.Clamp(rotDir.x, limitMinX, limitMaxX);
        targetDir = Quaternion.Euler(rotDir.x, rotDir.y, 0);
        _camController.originalRotation = targetDir; 
    }

    private void LateUpdate()
    {   
        // 플레이어 Aim
        transform.rotation = targetDir;

        // 카메라 상하좌우 회전 -> 카메라 위치를 업데이트
        if (_camController.IsShaking)
        {
            _camController.UpdateCameraPositionRotation(camPos.position, null);
        }
        else
        {
            _camController.UpdateCameraPositionRotation(camPos.position, targetDir);
        }
    }

    public void SetMousePos(Vector2 value)
    {
        mousePos = value;

        rotDir.y += mousePos.x * rotXSpeed * Time.deltaTime; // 좌우 
        rotDir.x -= mousePos.y * rotYSpeed * Time.deltaTime; // 상하
    }

    public void StartAimMode()
    {
        if (CanZoomIn)
        {
            _camController.ZoomIn();
            _anim.PlayAnimation("aim");
        }
    }

    public void EndAimMode()
    {
        _camController.ZoomOut();
        _anim.StopAnimation("aim");
    }
}
